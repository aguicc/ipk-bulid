# This is a basic workflow to help you get started with Actions
name: ipk-builder

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          submodules: recursive
          
      - name: Install all build dependencies (统一安装所有依赖)
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          # 基础编译依赖 + Rockchip U-Boot 专属依赖
          sudo apt install -y \
            build-essential ccache flex gawk gettext git libncurses5-dev libssl-dev \
            python3 python3-distutils rsync unzip zlib1g-dev libncursesw5-dev \
            xsltproc wget python3-pip python3-setuptools swig libelf-dev \
            device-tree-compiler bc flex bison gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
          sudo apt clean -y

      - name: Prepare config file (修复路径拼写错误)
        run: |
          # 正确的工作目录变量：GITHUB_WORKSPACE（少了一个C）
          cd "$GITHUB_WORKSPACE"
          # 下载配置文件并验证
          wget https://raw.githubusercontent.com/aguicc/ipk-bulid/main/localconfig/config -O .config
          if [ ! -f .config ]; then
            echo "Error: Config file download failed!"
            exit 1
          fi
          cat .config  # 输出配置内容，便于调试

      - name: Update feeds and install packages
        run: |
          cd "$GITHUB_WORKSPACE"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Prepare build environment
        run: |
          cd "$GITHUB_WORKSPACE"
          make defconfig
          # 下载所有依赖包（多线程），并清理损坏的文件（小于1024字节）
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile (关键修复：单线程+高详细度，优先编译uboot-rockchip)
        run: |
          cd "$GITHUB_WORKSPACE"
          # 第一步：单独编译uboot-rockchip，输出详细日志（核心调试步骤）
          echo "=== Compiling uboot-rockchip with verbose log ==="
          make package/boot/uboot-rockchip/clean
          make -j1 V=s package/boot/uboot-rockchip/compile
          
          # 如果uboot编译成功，再编译整个项目（单线程，避免资源问题）
          if [ $? -eq 0 ]; then
            echo "=== U-Boot compiled successfully, building full image ==="
            make -j1 V=s
          else
            echo "=== U-Boot compile failed! Check the log above ==="
            exit 1
          fi
