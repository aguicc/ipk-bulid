name: OpenWRT IPK Build (AArch64-musl)
on:
  workflow_dispatch:  # 仅手动触发（推荐，避免push频繁编译）
  push:
    branches: [ main ]
    paths-ignore: [ 'README.md', '*.md' ]  # 忽略文档提交

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200  # 延长超时，适配工具链编译
    steps:
      - name: 1. 拉取源码（递归子模块，修复源码缺失）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 2. 安装完整编译依赖（适配AArch64+musl+GCC）
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y --no-install-recommends \
            build-essential libncurses5-dev libncursesw5-dev zlib1g-dev \
            gawk git gettext libssl-dev liblz4-dev swig libelf-dev u-boot-tools \
            bc flex bison rsync unzip curl wget file python3 python3-pip \
            libgmp3-dev libmpc-dev libmpfr-dev texinfo dosfstools mtools
          sudo apt autoremove -y && sudo apt clean -y

      - name: 3. 配置交换空间（/mnt分区，4G，GitHub官方推荐）
        run: |
          # 检查/mnt磁盘空间
          df -h /mnt
          # 在/mnt创建4G交换文件，规避根分区tmpfs限制
          sudo fallocate -l 4G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          # 验证交换空间生效
          free -h
          swapon --show

      - name: 4. 清理残留缓存+配置稳定版工具链（GCC12.3.0）
        run: |
          cd $GITHUB_WORKSPACE
          # 彻底清理工具链/uboot残留编译文件
          make package/libs/toolchain/clean V=s || true
          make package/boot/uboot-rockchip/clean V=s || true
          rm -rf staging_dir/toolchain-aarch64_generic_* build_dir/target-aarch64_* || true
          # 替换toolchain为OpenWRT23.05稳定版（解决musl兼容问题）
          cd package/libs/toolchain
          git remote add openwrt https://github.com/openwrt/openwrt.git || true
          git fetch openwrt 23.05 --depth 1
          git checkout openwrt/23.05 -- . || true
          cd $GITHUB_WORKSPACE
          # 写入核心编译配置（AArch64+musl+GCC12.3.0）
          cat > .config << EOF
          CONFIG_TARGET_aarch64_generic=y
          CONFIG_TARGET_aarch64_generic_musl=y
          CONFIG_TOOLCHAIN=y
          CONFIG_TOOLCHAIN_GCC_VERSION="12.3.0"
          CONFIG_TOOLCHAIN_MUSL=y
          CONFIG_PACKAGE_uboot-rockchip=y
          CONFIG_DEVEL=y
          CONFIG_BUILD_LOG=y
          EOF
          make defconfig  # 生成完整配置

      - name: 5. 编译工具链（单独编译，验证产物，-j2保稳定）
        run: |
          cd $GITHUB_WORKSPACE
          make package/libs/toolchain/compile V=s -j2
          # 关键验证：确认ld-musl文件生成（解决原报错核心）
          ls -l staging_dir/toolchain-aarch64_generic_gcc-12.3.0_musl/lib/ld-musl-*

      - name: 6. 编译uboot-rockchip（-j2适配Runner资源）
        run: |
          cd $GITHUB_WORKSPACE
          make package/boot/uboot-rockchip/compile V=s -j2

      - name: 7. 提取编译产物（IPK+UBOOT二进制）
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p output/uboot output/ipk
          # 复制UBOOT产物
          find bin/targets/aarch64_generic/ -name "uboot-*.bin" -o -name "u-boot*.bin" | xargs -I {} cp {} output/uboot/
          # 复制工具链/uboot相关IPK
          find bin/packages/aarch64_generic/ -name "uboot*" -o -name "toolchain*" | xargs -I {} cp {} output/ipk/
          # 查看产物
          ls -l output/uboot/ output/ipk/

      - name: 8. 上传产物到Artifact（方便下载，保留7天）
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-aarch64-uboot-toolchain
          path: output/
          retention-days: 7
