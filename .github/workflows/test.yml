name: OpenWRT IPK Build (AArch64-musl)
on:
  workflow_dispatch:  # 仅手动触发，避免误执行
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200
    steps:
      - name: 1. 拉取仓库源码（含自定义OpenWRT工程）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          path: ipk-build  # 固定源码目录，避免路径混乱

      - name: 2. 安装完整编译依赖
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y --no-install-recommends \
            build-essential libncurses5-dev libncursesw5-dev zlib1g-dev \
            gawk git gettext libssl-dev liblz4-dev swig libelf-dev u-boot-tools \
            bc flex bison rsync unzip curl wget file python3 python3-pip \
            libgmp3-dev libmpc-dev libmpfr-dev texinfo dosfstools mtools
          sudo apt autoremove -y && sudo apt clean -y

      - name: 3. 配置4G交换空间（/mnt分区，GitHub官方推荐）
        run: |
          df -h /mnt
          sudo fallocate -l 4G /mnt/swapfile
          sudo chmod 600 /mnt/swapfile
          sudo mkswap /mnt/swapfile
          sudo swapon /mnt/swapfile
          free -h
          swapon --show

      - name: 4. 初始化OpenWRT编译环境（核心修复：生成Makefile规则）
        working-directory: ipk-build  # 进入OpenWRT工程根目录
        run: |
          # 若为OpenWRT官方源码，更新feeds并安装（必做步骤）
          [ -f ./scripts/feeds ] && ./scripts/feeds update -a && ./scripts/feeds install -a
          # 生成编译配置文件，创建核心Makefile规则
          touch .config && make defconfig
          # 检查关键目录是否存在，不存在则自动拉取（兼容自定义源码）
          if [ ! -d "package/libs/toolchain" ]; then
              git clone --depth 1 https://github.com/openwrt/openwrt -b 23.05 openwrt-tmp
              cp -rf openwrt-tmp/package/libs/toolchain package/libs/
              cp -rf openwrt-tmp/package/boot/uboot-rockchip package/boot/
              rm -rf openwrt-tmp
          fi
          # 验证目录是否存在
          ls -ld package/libs/toolchain package/boot/uboot-rockchip

      - name: 5. 清理残留编译缓存
        working-directory: ipk-build
        run: |
          # 容错执行clean，避免目录刚创建无缓存时报错
          make package/libs/toolchain/clean V=s || true
          make package/boot/uboot-rockchip/clean V=s || true
          rm -rf staging_dir/toolchain-aarch64_generic_* build_dir/target-aarch64_* || true

      - name: 6. 配置编译参数（AArch64+musl+GCC12.3.0稳定版）
        working-directory: ipk-build
        run: |
          cat > .config << EOF
          CONFIG_TARGET_aarch64_generic=y
          CONFIG_TARGET_aarch64_generic_musl=y
          CONFIG_TOOLCHAIN=y
          CONFIG_TOOLCHAIN_GCC_VERSION="12.3.0"
          CONFIG_TOOLCHAIN_MUSL=y
          CONFIG_PACKAGE_uboot-rockchip=y
          CONFIG_DEVEL=y
          CONFIG_BUILD_LOG=y
          CONFIG_SKIP_PACKAGE_CHECK=y
          EOF
          make defconfig  # 生成完整编译规则

      - name: 7. 编译工具链（-j2适配Runner，V=s看详细日志）
        working-directory: ipk-build
        run: |
          make package/libs/toolchain/compile V=s -j2
          # 验证核心文件是否生成（解决原ld-musl缺失问题）
          ls -l staging_dir/toolchain-aarch64_generic_gcc-12.3.0_musl/lib/ld-musl-*

      - name: 8. 编译uboot-rockchip
        working-directory: ipk-build
        run: |
          make package/boot/uboot-rockchip/compile V=s -j2

      - name: 9. 提取编译产物
        working-directory: ipk-build
        run: |
          mkdir -p output/uboot output/ipk
          find bin/targets/aarch64_generic/ -name "uboot-*.bin" -o -name "u-boot*.bin" | xargs -I {} cp {} output/uboot/ || true
          find bin/packages/aarch64_generic/ -name "*.ipk" | xargs -I {} cp {} output/ipk/ || true
          ls -l output/uboot/ output/ipk/ || true

      - name: 10. 上传产物到Artifact（方便下载）
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-aarch64-uboot-toolchain
          path: ipk-build/output/
          retention-days: 7
